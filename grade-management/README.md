# Grade Management

This application aims to aid teachers by removing the need to record grades of homework submissions manually. Automated evaluation yields points/grades, and teachers can override them in GitHub pull requests.

This application is not stand-alone; it works with the other parts of the toolset in this repository, namely

- the [GitHub Monitor](../github-monitor) application running as a GitHub App forwarding events to this application,
- and [Publish Results to PR](../publish-results-pr) running in GitHub Actions workflows in student repositories pushing automatically evaluated results to this application.

## Global configuration of the application

The application requires the following **mandatory** configurations specified as **environment variables**.

`CosmosAccountEndpoint` and `CosmosAccountKey`: The endpoint name (URL) and the access key of the CosmosDB database used as backing data storage.

`AHK_EventsQueueConnectionString`: The connection string of the Azure Queue Storage used by _GitHub Monitor_ to send grade events; e.g., `DefaultEndpointsProtocol=https;AccountName=mystorageaccount;AccountKey=mykey;EndpointSuffix=core.windows.net`

## Use cases

### Use case: Automated evaluation result

When the automated evaluation is executed, the results are published using [Publish Results to PR](../publish-results-pr) containerized application sending the results to a webhook of this application. The results are saved in a CosmosDB database. The process is visualized below:

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5cbiAgcGFydGljaXBhbnQgc3R1ZGVudCBhcyBzdHVkZW50XG4gIHBhcnRpY2lwYW50IGdocmVwbyBhcyBHaXRIdWIgcmVwb3NpdG9yeVxuICBwYXJ0aWNpcGFudCBnaGFjdGlvbiBhcyBHaXRIdWIgQWN0aW9uc1xuICBwYXJ0aWNpcGFudCBldmFsYXBwIGFzIGV2YWx1YXRvciAoY29udGFpbmVyKVxuICBwYXJ0aWNpcGFudCByZXN1bHRwcm9jIGFzIGFoay1wdWJsaXNoLXJlc3VsdHMtcHIgKGNvbnRhaW5lcilcbiAgcGFydGljaXBhbnQgcmVzdWx0ZnVuIGFzIGdyYWRlLW1hbmFnZW1lbnQgKEF6dXJlIGZ1bmMpXG4gIHBhcnRpY2lwYW50IGRiIGFzIGRhdGFiYXNlXG4gIHBhcnRpY2lwYW50IGdoYXBpIGFzIEdpdEh1YiBBUElcblxuICBzdHVkZW50IC0-PiBnaHJlcG86IHB1c2hcbiAgYWN0aXZhdGUgZ2hyZXBvXG4gIGdocmVwbyAtKSBnaGFjdGlvbjogdHJpZ2dlclxuICBkZWFjdGl2YXRlIGdocmVwb1xuICBhY3RpdmF0ZSBnaGFjdGlvblxuICBcbiAgZ2hhY3Rpb24gLT4-ICtldmFsYXBwOiBydW4gZXZhbHVhdGlvblxuICBldmFsYXBwIC0tPj4gLWdoYWN0aW9uOiBldmFsdWF0aW9uIHJlc3VsdCAoZmlsZXMpXG4gIGdoYWN0aW9uIC0-PiByZXN1bHRwcm9jOiBydW5cbiAgYWN0aXZhdGUgcmVzdWx0cHJvY1xuICByZXN1bHRwcm9jIC0-PiByZXN1bHRwcm9jOiBwcm9jZXNzIGV2YWx1YXRpb24gZmlsZXNcblxuICByZXN1bHRwcm9jIC0-PiByZXN1bHRmdW46IHNlbmQgcmVzdWx0cyAoaHR0cHMpXG4gIGFjdGl2YXRlIHJlc3VsdGZ1blxuICBOb3RlIHJpZ2h0IG9mIHJlc3VsdHByb2M6IHNlY3VyZWQgYnk6IHRva2VuPGJyLz4gJiBITUFDLVNIQTI1NiBzaWduYXR1cmVcblxuICByZXN1bHRmdW4gLT4-IGRiOiBzYXZlXG4gIGFjdGl2YXRlIGRiXG4gIGRlYWN0aXZhdGUgZGJcblxuICBkZWFjdGl2YXRlIHJlc3VsdGZ1blxuXG4gIHJlc3VsdHByb2MgLT4-IGdoYXBpOiBhZGQgY29tbWVudFxuICBhY3RpdmF0ZSBnaGFwaVxuICBOb3RlIG92ZXIgZGI6IEdpdEh1YiBBUEkgYWNjZXNzOiBHaXRIdWIgQXBwIGF1dGhlbnRpY2F0aW9uXG4gIGRlYWN0aXZhdGUgZ2hhcGlcblxuICBkZWFjdGl2YXRlIGdoYWN0aW9uXG4gIGRlYWN0aXZhdGUgcmVzdWx0cHJvYyIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjpmYWxzZX0)](https://mermaid-js.github.io/mermaid-live-editor/edit/##eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5cbiAgcGFydGljaXBhbnQgc3R1ZGVudCBhcyBzdHVkZW50XG4gIHBhcnRpY2lwYW50IGdocmVwbyBhcyBHaXRIdWIgcmVwb3NpdG9yeVxuICBwYXJ0aWNpcGFudCBnaGFjdGlvbiBhcyBHaXRIdWIgQWN0aW9uc1xuICBwYXJ0aWNpcGFudCBldmFsYXBwIGFzIGV2YWx1YXRvciAoY29udGFpbmVyKVxuICBwYXJ0aWNpcGFudCByZXN1bHRwcm9jIGFzIGFoay1wdWJsaXNoLXJlc3VsdHMtcHIgKGNvbnRhaW5lcilcbiAgcGFydGljaXBhbnQgcmVzdWx0ZnVuIGFzIGdyYWRlLW1hbmFnZW1lbnQgKEF6dXJlIGZ1bmMpXG4gIHBhcnRpY2lwYW50IGRiIGFzIGRhdGFiYXNlXG4gIHBhcnRpY2lwYW50IGdoYXBpIGFzIEdpdEh1YiBBUElcblxuICBzdHVkZW50IC0-PiBnaHJlcG86IHB1c2hcbiAgYWN0aXZhdGUgZ2hyZXBvXG4gIGdocmVwbyAtKSBnaGFjdGlvbjogdHJpZ2dlclxuICBkZWFjdGl2YXRlIGdocmVwb1xuICBhY3RpdmF0ZSBnaGFjdGlvblxuICBcbiAgZ2hhY3Rpb24gLT4-ICtldmFsYXBwOiBydW4gZXZhbHVhdGlvblxuICBldmFsYXBwIC0tPj4gLWdoYWN0aW9uOiBldmFsdWF0aW9uIHJlc3VsdCAoZmlsZXMpXG4gIGdoYWN0aW9uIC0-PiByZXN1bHRwcm9jOiBydW5cbiAgYWN0aXZhdGUgcmVzdWx0cHJvY1xuICByZXN1bHRwcm9jIC0-PiByZXN1bHRwcm9jOiBwcm9jZXNzIGV2YWx1YXRpb24gZmlsZXNcblxuICByZXN1bHRwcm9jIC0-PiByZXN1bHRmdW46IHNlbmQgcmVzdWx0cyAoaHR0cHMpXG4gIGFjdGl2YXRlIHJlc3VsdGZ1blxuICBOb3RlIHJpZ2h0IG9mIHJlc3VsdHByb2M6IHNlY3VyZWQgYnk6IHRva2VuPGJyLz4gJiBITUFDLVNIQTI1NiBzaWduYXR1cmVcblxuICByZXN1bHRmdW4gLT4-IGRiOiBzYXZlXG4gIGFjdGl2YXRlIGRiXG4gIGRlYWN0aXZhdGUgZGJcblxuICBkZWFjdGl2YXRlIHJlc3VsdGZ1blxuXG4gIHJlc3VsdHByb2MgLT4-IGdoYXBpOiBhZGQgY29tbWVudFxuICBhY3RpdmF0ZSBnaGFwaVxuICBOb3RlIG92ZXIgZGI6IEdpdEh1YiBBUEkgYWNjZXNzOiBHaXRIdWIgQXBwIGF1dGhlbnRpY2F0aW9uXG4gIGRlYWN0aXZhdGUgZ2hhcGlcblxuICBkZWFjdGl2YXRlIGdoYWN0aW9uXG4gZGVhY3RpdmF0ZSByZXN1bHRwcm9jIiwibWVybWFpZCI6IntcbiAgXCJ0aGVtZVwiOiBcImRlZmF1bHRcIlxufSIsInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjpmYWxzZX0)

#### Authentication of requests

In order to authorize webhook requests the application requires a token, a HMAC-SHA256 signature, and the date in each request's header as follows:

- `X-Ahk-Token`: The token is a string value known to this application (available in its database).
- `X-Ahk-Sha256`: The signature of the request (see below).
- `Date`: The date of sending the request in RFC1123 format.

To protect against replay attacks, the date of sending the request is expected in both the signature and request header. The server validates whether the provided date is current - a maximum skew of 10 minutes is tolerated.

##### Signing requests

The signature is based on a secret value paired with the token (also stored in the database). Multiple token-signature values are allowed. The application considers a request valid when the provided token is valid, and the signature matches the expected value computed with the token's corresponding secret.

The signature calculation algorithm is as follows:

1. Write the following data as bytes to a temporary stream:
   1. The HTTP verb used to send the data. Must be uppercase.
   1. A single `\n` character.
   1. The URL (with scheme, host, port, and path) the request is sent to. The value must be all lowercase. (Note, that in case the webhook is running behind a reverse proxy the application must be configured such that it receives the external, public address the request was sent to.)
   1. A single `\n` character.
   1. The date of sending the request. Must be the same value sent in header.
   1. A single `\n` character.
   1. The request payload
1. Calculate the HMAC-SHA256 hash of the byte array composed in the previous step using the byte representation of the secret as initialization key.
1. Get the base64 encoded string value of the hash. This string is the signature.

### Use case: Grade override by teacher

The previous use-case saves automatically evaluated results. If the teacher wants to override the points/grades [GitHub Monitor](../github-monitor) accepts certain comments added to pull requests as commands. These commands, containing the grades/points are forwarded to this application via an Azure Queue Storage. The process is visualized below:

[![](https://mermaid.ink/img/eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5cbiAgcGFydGljaXBhbnQgdGVhY2hlciBhcyB0ZWFjaGVyXG4gIHBhcnRpY2lwYW50IGdocHIgYXMgR2l0SHViIHB1bGwgcmVxdWVzdFxuICBwYXJ0aWNpcGFudCBhendlYmhvb2tmdW5jIGFzIEdpdEh1YiB3ZWJob29rIChBenVyZSBmdW5jKVxuICBwYXJ0aWNpcGFudCBldmVudHF1ZXVlIGFzIGV2ZW50IHF1ZXVlIChBenVyZSBxdWV1ZSlcbiAgcGFydGljaXBhbnQgcmVzdWx0ZnVuIGFzIEFoay1tZ210IChBenVyZSBmdW5jKVxuICBwYXJ0aWNpcGFudCBkYiBhcyBkYXRhYmFzZVxuXG4gIHRlYWNoZXIgLT4-IGdocHI6IGFkZCBjb21tZW50XG4gIGFjdGl2YXRlIGdocHJcbiAgZ2hwciAtKSBhendlYmhvb2tmdW5jOiBzZW5kIHdlYmhvb2sgKGh0dHBzKVxuICBkZWFjdGl2YXRlIGdocHJcblxuICBhY3RpdmF0ZSBhendlYmhvb2tmdW5jXG4gIE5vdGUgcmlnaHQgb2YgZ2hwcjogR2l0SHViIEFwcCBldmVudDxici8-c2VjdXJlZCBieTogR2l0SHViIEFwcCBzZWNyZXRcbiAgXG4gIGF6d2ViaG9va2Z1bmMgLT4-IGF6d2ViaG9va2Z1bmM6IHByb2Nlc3MgY29tbWVudFxuICBhendlYmhvb2tmdW5jIC0-PiBldmVudHF1ZXVlOiBhZGQgZXZlbnRcbiAgYWN0aXZhdGUgZXZlbnRxdWV1ZVxuICBOb3RlIHJpZ2h0IG9mIGF6d2ViaG9va2Z1bmM6IHNlY3VyZWQgYnk6IEF6dXJlIGtleSBhY2Nlc3MgdG8gUXVldWVcbiAgZGVhY3RpdmF0ZSBldmVudHF1ZXVlXG4gIGRlYWN0aXZhdGUgYXp3ZWJob29rZnVuY1xuXG4gIGV2ZW50cXVldWUgLSkgK3Jlc3VsdGZ1bjogZXZlbnQgdHJpZ2dlclxuICBhY3RpdmF0ZSByZXN1bHRmdW5cbiAgTm90ZSByaWdodCBvZiBldmVudHF1ZXVlOiBBenVyZSBGdW5jdGlvbiB0cmlnZ2VyPGJyLz5zZWN1cmVkIGJ5OiBBenVyZSBrZXkgYWNjZXNzIHRvIFF1ZXVlXG5cbiAgcmVzdWx0ZnVuIC0-PiByZXN1bHRmdW46IHByb2Nlc3NcblxuICByZXN1bHRmdW4gLT4-IGRiOiBzYXZlXG4gIGFjdGl2YXRlIGRiXG4gIGRlYWN0aXZhdGUgZGJcblxuICBkZWFjdGl2YXRlIHJlc3VsdGZ1biIsIm1lcm1haWQiOnsidGhlbWUiOiJkZWZhdWx0In0sInVwZGF0ZUVkaXRvciI6ZmFsc2UsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjp0cnVlfQ)](https://mermaid-js.github.io/mermaid-live-editor/edit/##eyJjb2RlIjoic2VxdWVuY2VEaWFncmFtXG5cbiAgcGFydGljaXBhbnQgdGVhY2hlciBhcyB0ZWFjaGVyXG4gIHBhcnRpY2lwYW50IGdocHIgYXMgR2l0SHViIHB1bGwgcmVxdWVzdFxuICBwYXJ0aWNpcGFudCBhendlYmhvb2tmdW5jIGFzIEdpdEh1YiB3ZWJob29rIChBenVyZSBmdW5jKVxuICBwYXJ0aWNpcGFudCBldmVudHF1ZXVlIGFzIGV2ZW50IHF1ZXVlIChBenVyZSBxdWV1ZSlcbiAgcGFydGljaXBhbnQgcmVzdWx0ZnVuIGFzIEFoay1tZ210IChBenVyZSBmdW5jKVxuICBwYXJ0aWNpcGFudCBkYiBhcyBkYXRhYmFzZVxuXG4gIHRlYWNoZXIgLT4-IGdocHI6IGFkZCBjb21tZW50XG4gIGFjdGl2YXRlIGdocHJcbiAgZ2hwciAtKSBhendlYmhvb2tmdW5jOiBzZW5kIHdlYmhvb2sgKGh0dHBzKVxuICBkZWFjdGl2YXRlIGdocHJcblxuICBhY3RpdmF0ZSBhendlYmhvb2tmdW5jXG4gIE5vdGUgcmlnaHQgb2YgZ2hwcjogR2l0SHViIEFwcCBldmVudDxici8-c2VjdXJlZCBieTogR2l0SHViIEFwcCBzZWNyZXRcbiAgXG4gIGF6d2ViaG9va2Z1bmMgLT4-IGF6d2ViaG9va2Z1bmM6IHByb2Nlc3MgY29tbWVudFxuICBhendlYmhvb2tmdW5jIC0-PiBldmVudHF1ZXVlOiBhZGQgZXZlbnRcbiAgYWN0aXZhdGUgZXZlbnRxdWV1ZVxuICBOb3RlIHJpZ2h0IG9mIGF6d2ViaG9va2Z1bmM6IHNlY3VyZWQgYnk6IEF6dXJlIGtleSBhY2Nlc3MgdG8gUXVldWVcbiAgZGVhY3RpdmF0ZSBldmVudHF1ZXVlXG4gIGRlYWN0aXZhdGUgYXp3ZWJob29rZnVuY1xuXG4gIGV2ZW50cXVldWUgLSkgK3Jlc3VsdGZ1bjogZXZlbnQgdHJpZ2dlclxuICBhY3RpdmF0ZSByZXN1bHRmdW5cbiAgTm90ZSByaWdodCBvZiBldmVudHF1ZXVlOiBBenVyZSBGdW5jdGlvbiB0cmlnZ2VyPGJyLz5zZWN1cmVkIGJ5OiBBenVyZSBrZXkgYWNjZXNzIHRvIFF1ZXVlXG5cbiAgcmVzdWx0ZnVuIC0-PiByZXN1bHRmdW46IHByb2Nlc3NcblxuICByZXN1bHRmdW4gLT4-IGRiOiBzYXZlXG4gIGFjdGl2YXRlIGRiXG4gIGRlYWN0aXZhdGUgZGJcblxuICBkZWFjdGl2YXRlIHJlc3VsdGZ1biIsIm1lcm1haWQiOiJ7XG4gIFwidGhlbWVcIjogXCJkZWZhdWx0XCJcbn0iLCJ1cGRhdGVFZGl0b3IiOnRydWUsImF1dG9TeW5jIjp0cnVlLCJ1cGRhdGVEaWFncmFtIjp0cnVlfQ)
